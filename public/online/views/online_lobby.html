<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルームロビー - オンラインプレイ | Tokyo Flag Capturing Geoguesser</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/online/online_rooms.css">
</head>
<body>
    <script>
        let roomId = null;
        let currentUser = null;
        let isHost = false;
        let pollInterval = null;

        // ページロード時の初期化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('lobby page loading...');

            // リダイレクトループ防止用フラグ
            if (sessionStorage.getItem('lobbyRedirecting') === 'true') {
                console.log('リダイレクトループを検出、ループを中断');
                showError('認証エラーが発生しました。再度ログインしてください。');
                sessionStorage.removeItem('lobbyRedirecting');
                return;
            }

            try {
                // URLパラメータからルームIDを取得
                const urlParams = new URLSearchParams(window.location.search);
                roomId = urlParams.get('roomId');

                console.log('Room ID:', roomId);

                if (!roomId) {
                    showError('ルームIDが指定されていません');
                    return;
                }

                console.log('認証状態チェック開始...');

                // 認証状態をチェック
                const authResponse = await fetch('/auth/me', {
                    credentials: 'include'
                });

                console.log('認証レスポンス:', authResponse.status, authResponse.ok);

                if (!authResponse.ok) {
                    console.error('認証チェックエラー:', authResponse.status);
                    sessionStorage.setItem('lobbyRedirecting', 'true');
                    setTimeout(() => {
                        window.location.href = '/login?returnUrl=' + encodeURIComponent(`/online/views/online_lobby.html?roomId=${roomId}`);
                    }, 1000);
                    return;
                }

                const authData = await authResponse.json();
                console.log('認証データ:', authData);

                if (!authData || !authData.success || !authData.data) {
                    console.error('認証失敗またはユーザー情報なし:', authData);
                    sessionStorage.setItem('lobbyRedirecting', 'true');
                    setTimeout(() => {
                        window.location.href = '/login?returnUrl=' + encodeURIComponent(`/online/views/online_lobby.html?roomId=${roomId}`);
                    }, 1000);
                    return;
                }

                currentUser = authData.data; // authData.user -> authData.data
                console.log('認証済みユーザー:', currentUser);

                // ロビー機能を初期化
                await initializeLobby();

                // 定期的にルーム情報を更新
                startPolling();

            } catch (error) {
                console.error('初期化エラー:', error);
                showError(`ページの初期化に失敗しました: ${error.message}`);
            }
        });

        async function initializeLobby() {
            // ルーム情報を取得
            await updateRoomInfo();

            // ボタンイベントリスナーを設定
            document.getElementById('ready-btn')?.addEventListener('click', handleReadyOrStart);
            document.getElementById('leave-room-btn')?.addEventListener('click', leaveRoom);
        }

        async function updateRoomInfo() {
            try {
                console.log('ルーム情報取得開始...', roomId);

                const response = await fetch(`/multi/rooms/${roomId}`, {
                    credentials: 'include'
                });

                console.log('ルーム情報レスポンス:', response.status, response.ok);

                // レスポンスの状態を確認
                if (!response.ok) {
                    console.error('HTTP Error:', response.status, response.statusText);
                    if (response.status === 401) {
                        showError('認証エラー: ログインしてください');
                        stopPolling(); // ポーリングを停止
                        sessionStorage.setItem('lobbyRedirecting', 'true');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                        return;
                    }
                    if (response.status === 404) {
                        showError('ルームが見つかりません');
                        stopPolling();
                        return;
                    }
                    showError(`サーバーエラー: ${response.status}`);
                    return;
                }

                const data = await response.json();
                console.log('Room data received:', data);

                if (data.success) {
                    // 正常にデータを取得できた場合、リダイレクトフラグをクリア
                    sessionStorage.removeItem('lobbyRedirecting');
                    renderRoomInfo(data.data);
                } else {
                    console.error('ルーム情報取得失敗:', data);
                    showError(data.message || 'ルーム情報の取得に失敗しました');
                }

            } catch (error) {
                console.error('ルーム情報取得エラー:', error);
                showError(`ネットワークエラー: ${error.message}`);
                // ネットワークエラーの場合はポーリングを停止
                stopPolling();
            }
        }

        function renderRoomInfo(roomData) {
            // 基本情報を表示
            document.getElementById('room-key-display').textContent = roomData.roomKey;
            document.getElementById('player-count').textContent = roomData.players.length;
            document.getElementById('max-players').textContent = roomData.settings.maxPlayers;
            document.getElementById('round-count').textContent = roomData.settings.roundCount;

            // ホストかどうかを確認
            console.log('ホスト判定:', {
                hostId: roomData.hostId,
                currentUserId: currentUser.id,
                currentUser: currentUser
            });
            isHost = roomData.hostId === currentUser.id;

            // ゲーム開始状態をチェック（全プレイヤー用）
            if (roomData.status === 'playing') {
                console.log('ゲームが開始されました。ゲーム画面に移動します...');
                stopPolling(); // ポーリングを停止
                showGameStartMessage();
                setTimeout(() => {
                    window.location.href = `/online/views/online_game.html?roomId=${roomId}`;
                }, 2000); // 2秒後にゲーム画面に移動
                return;
            }

            // プレイヤーリストを表示
            renderPlayerList(roomData.players);

            // ボタンの状態を更新
            updateButtons(roomData);
        }

        function renderPlayerList(players) {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';

                const readyStatus = player.isReady ? '✅ 準備完了' : '⏳ 待機中';
                const hostBadge = player.isHost ? '👑 ' : '';

                playerElement.innerHTML = `
                    <div class="player-info">
                        <span class="player-name">${hostBadge}${player.username}</span>
                        <span class="player-status ${player.isReady ? 'ready' : 'waiting'}">${readyStatus}</span>
                    </div>
                `;

                playersList.appendChild(playerElement);
            });
        }

        function updateButtons(roomData) {
            const readyBtn = document.getElementById('ready-btn');

            if (isHost) {
                // ホストの場合 - 準備ボタンをゲームスタートボタンに変更
                readyBtn.style.display = 'block';

                // 全員が準備完了かチェック
                const allReady = roomData.players.every(p => p.isHost || p.isReady);
                const hasEnoughPlayers = roomData.players.length >= 2;

                console.log('ホスト用ボタン状態:', {
                    allReady,
                    hasEnoughPlayers,
                    playersCount: roomData.players.length,
                    players: roomData.players.map(p => ({ name: p.username, isReady: p.isReady, isHost: p.isHost }))
                });

                // ボタンをゲームスタートボタンのスタイルに変更
                readyBtn.className = 'lobby-start-game-button';
                readyBtn.disabled = !allReady || !hasEnoughPlayers;

                // 星のSVGを追加
                if (!readyBtn.querySelector('.star-1')) {
                    readyBtn.innerHTML = `
                        Game Start !!
                        <div class="star-1">
                            <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
                                <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path>
                            </svg>
                        </div>
                        <div class="star-2">
                            <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
                                <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path>
                            </svg>
                        </div>
                        <div class="star-3">
                            <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
                                <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path>
                            </svg>
                        </div>
                        <div class="star-4">
                            <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
                                <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path>
                            </svg>
                        </div>
                        <div class="star-5">
                            <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
                                <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path>
                            </svg>
                        </div>
                        <div class="star-6">
                            <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
                                <path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path>
                            </svg>
                        </div>
                    `;
                }

                if (allReady && hasEnoughPlayers) {
                    readyBtn.querySelector('svg').style.display = ''; // 星を表示
                } else {
                    // 無効状態のテキストを設定
                    if (!hasEnoughPlayers) {
                        readyBtn.childNodes[0].textContent = '最低2人必要です';
                    } else {
                        readyBtn.childNodes[0].textContent = 'GameStart !!';
                    }
                }

            } else {
                // 参加者の場合 - 通常の準備ボタン
                readyBtn.style.display = 'block';
                readyBtn.className = 'submit-btn';

                const currentUserId = currentUser.id;
                const currentPlayer = roomData.players.find(p => {
                    const playerId = p.userId._id || p.userId;
                    return playerId === currentUserId;
                });
                const isCurrentlyReady = currentPlayer ? currentPlayer.isReady : false;

                readyBtn.textContent = isCurrentlyReady ? '準備完了 ✅' : '準備OK';
                if (isCurrentlyReady) {
                    readyBtn.className += ' ready-active';
                }
                readyBtn.disabled = false;
            }
        }

        async function handleReadyOrStart() {
            if (isHost) {
                // ホストの場合はゲーム開始
                await startGame();
            } else {
                // 参加者の場合は準備状態切り替え
                await toggleReady();
            }
        }

        async function toggleReady() {
            try {
                const readyBtn = document.getElementById('ready-btn');
                const isCurrentlyReady = readyBtn.textContent.includes('✅');

                console.log('準備状態変更開始:', { isCurrentlyReady, newState: !isCurrentlyReady });

                const response = await fetch(`/multi/rooms/${roomId}/ready`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        isReady: !isCurrentlyReady
                    })
                });

                console.log('準備状態変更レスポンス:', response.status, response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('準備状態変更HTTP Error:', response.status, errorText);
                    showError(`準備状態の更新に失敗しました (${response.status})`);
                    return;
                }

                const data = await response.json();
                console.log('準備状態変更データ:', data);

                if (data.success) {
                    // 直接ボタンの状態を更新（ポーリングで同期を取る）
                    updateReadyButton(data.data.isReady);

                    // ルーム情報の更新は必要な場合のみ行う
                    try {
                        await updateRoomInfo();
                    } catch (updateError) {
                        console.warn('ルーム情報更新でエラーが発生しましたが、準備状態の変更は成功しました:', updateError);
                        // ルーム情報更新のエラーは致命的ではないため、ポーリングで回復を期待
                    }
                } else {
                    showError(data.message || '準備状態の更新に失敗しました');
                }

            } catch (error) {
                console.error('準備状態更新エラー:', error);
                showError(`準備状態の変更でネットワークエラーが発生しました: ${error.message}`);
            }
        }

        // 準備ボタンの状態を直接更新する関数
        function updateReadyButton(isReady) {
            const readyBtn = document.getElementById('ready-btn');
            if (readyBtn && !isHost) {
                readyBtn.textContent = isReady ? '準備完了 ✅' : '準備OK';
                if (isReady) {
                    readyBtn.className = 'submit-btn ready-active';
                } else {
                    readyBtn.className = 'submit-btn';
                }
            }
        }

        // --- game.jsから移植した高品質な座標生成ロジック ---
        const TOKYO_23_WARDS_POLYGON=[[35.676,139.692],[35.69,139.701],[35.695,139.715],[35.686,139.723],[35.68,139.74],[35.67,139.748],[35.66,139.752],[35.648,139.747],[35.642,139.737],[35.639,139.725],[35.645,139.71],[35.658,139.69],[35.67,139.685],[35.685,139.69],[35.693,139.678],[35.702,139.683],[35.708,139.695],[35.715,139.702],[35.72,139.715],[35.728,139.72],[35.735,139.71],[35.742,139.715],[35.748,139.725],[35.755,139.735],[35.762,139.745],[35.768,139.752],[35.775,139.758],[35.785,139.765],[35.795,139.772],[35.805,139.78],[35.815,139.785],[35.825,139.792],[35.835,139.8],[35.845,139.808],[35.855,139.815],[35.865,139.825],[35.872,139.835],[35.878,139.845],[35.882,139.855],[35.885,139.865],[35.88,139.87],[35.875,139.875],[35.868,139.868],[35.86,139.86],[35.85,139.855],[35.84,139.848],[35.828,139.842],[35.815,139.835],[35.805,139.828],[35.795,139.82],[35.785,139.812],[35.775,139.805],[35.765,139.798],[35.755,139.792],[35.745,139.785],[35.735,139.778],[35.725,139.77],[35.715,139.762],[35.705,139.755],[35.695,139.748],[35.685,139.742],[35.675,139.735],[35.665,139.728],[35.655,139.72],[35.645,139.712],[35.635,139.705],[35.625,139.698],[35.615,139.692],[35.605,139.685],[35.595,139.678],[35.585,139.672],[35.575,139.665],[35.565,139.658],[35.555,139.652],[35.545,139.645],[35.54,139.638],[35.545,139.628],[35.552,139.618],[35.56,139.608],[35.57,139.598],[35.58,139.59],[35.59,139.582],[35.6,139.575],[35.61,139.568],[35.62,139.562],[35.63,139.555],[35.64,139.55],[35.65,139.545],[35.66,139.54],[35.67,139.535],[35.68,139.53],[35.688,139.538],[35.695,139.548],[35.702,139.558],[35.708,139.568],[35.715,139.578],[35.722,139.588],[35.73,139.598],[35.738,139.608],[35.745,139.618],[35.752,139.628],[35.76,139.638],[35.768,139.648],[35.775,139.658],[35.782,139.668],[35.788,139.678],[35.795,139.688],[35.802,139.698],[35.808,139.708],[35.815,139.718],[35.676,139.692]];
        const WATER_EXCLUSION_ZONES=[{name:"東京湾",polygon:[[35.53,139.75],[35.53,139.87],[35.62,139.87],[35.63,139.82],[35.64,139.78],[35.65,139.76]]},{name:"隅田川",polygon:[[35.66,139.78],[35.665,139.785],[35.72,139.8],[35.75,139.81],[35.76,139.815],[35.758,139.82],[35.718,139.805],[35.663,139.785],[35.658,139.782]]},{name:"荒川",polygon:[[35.76,139.815],[35.78,139.825],[35.82,139.845],[35.85,139.865],[35.852,139.87],[35.848,139.872],[35.818,139.85],[35.778,139.83],[35.758,139.82]]},{name:"皇居濠",polygon:[[35.679,139.744],[35.685,139.75],[35.69,139.756],[35.688,139.762],[35.682,139.76],[35.677,139.754]]}];
        const MAJOR_ROAD_ZONES=[{center:[35.681,139.767],radius:800,weight:3},{center:[35.689,139.692],radius:600,weight:3},{center:[35.659,139.701],radius:600,weight:3},{center:[35.729,139.731],radius:500,weight:2},{center:[35.63,139.74],radius:500,weight:2},{center:[35.67,139.802],radius:500,weight:2},{center:[35.696,139.614],radius:400,weight:2},{center:[35.738,139.669],radius:400,weight:2},{center:[35.643,139.716],radius:400,weight:2},{center:[35.712,139.61],radius:400,weight:2},{center:[35.7,139.773],radius:300,weight:1},{center:[35.646,139.71],radius:300,weight:1},{center:[35.665,139.731],radius:300,weight:1},{center:[35.667,139.65],radius:300,weight:1}];
        const pointInPolygon=(t,o,n)=>{let e=!1;for(let s=0,a=n.length-1;s<n.length;a=s++)n[s][0]>t!=n[a][0]>t&&o<(n[a][1]-n[s][1])*(t-n[s][0])/(n[a][0]-n[s][0])+n[s][1]&&(e=!e);return e};
        const isValidLocation=(t,o)=>{if(!pointInPolygon(t,o,TOKYO_23_WARDS_POLYGON))return!1;for(const n of WATER_EXCLUSION_ZONES)if(pointInPolygon(t,o,n.polygon))return!1;return!0};
        const generateWeightedRandomLocation=()=>{const t=MAJOR_ROAD_ZONES.reduce((t,o)=>t+o.weight,0);let o=Math.random()*t;let n=MAJOR_ROAD_ZONES[0];for(const t of MAJOR_ROAD_ZONES)if(o-=t.weight,o<=0){n=t;break}const e=2*Math.random()*Math.PI,s=Math.random()*n.radius,a=n.center[0]+s*Math.cos(e)/111320,r=n.center[1]+s*Math.sin(e)/(111320*Math.cos(n.center[0]*Math.PI/180));return{lat:a,lng:r}};

        async function checkStreetView(lat, lng, radius) {
            const response = await fetch('/api/streetview/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat, lng, radius })
            });
            const data = await response.json();
            if (data.success && data.data.status === 'OK') {
                return { lat: data.data.location.lat, lng: data.data.location.lng };
            }
            return null;
        }

        async function findValidLocation(generationFunc, checkRadius) {
            let attempts = 0;
            while (attempts < 50) {
                const { lat, lng } = generationFunc();
                if (isValidLocation(lat, lng)) {
                    const svLocation = await checkStreetView(lat, lng, checkRadius);
                    if (svLocation) {
                        return svLocation;
                    }
                }
                attempts++;
            }
            console.warn('有効な場所の検索がタイムアウトしました。フォールバックします。');
            return null;
        }

        async function generateTargetLocation() {
            const location = await findValidLocation(() => {
                return Math.random() < 0.8 ? generateWeightedRandomLocation() : { lat: 35.53 + Math.random() * 0.35, lng: 139.34 + Math.random() * 0.54 };
            }, 500);
            return location || { lat: 35.681236, lng: 139.767125 }; // フォールバック: 東京駅
        }

        // 各プレイヤーに異なるスポーン位置を生成（3km圏内確実）
        function generatePlayerStartPosition(targetLocation, playerIndex = 0, totalPlayers = 1) {
            // プレイヤーごとに異なる角度範囲を割り当て
            const angleSegment = (2 * Math.PI) / Math.max(totalPlayers, 2);
            const baseAngle = angleSegment * playerIndex;
            const angleVariation = angleSegment * 0.8; // セグメント内でのランダム変動

            const angle = baseAngle + (Math.random() * angleVariation - angleVariation / 2);
            const distance = 500 + Math.random() * 2500; // 500m～3000m（フラッグから離れた位置）

            // 座標計算（高精度）
            const lat = targetLocation.lat + (distance * Math.cos(angle)) / 111320;
            const lng = targetLocation.lng + (distance * Math.sin(angle)) / (111320 * Math.cos(targetLocation.lat * Math.PI / 180));

            console.log(`プレイヤー${playerIndex + 1}のスポーン: 角度${(angle * 180 / Math.PI).toFixed(1)}°, 距離${distance.toFixed(0)}m`);

            return { lat, lng };
        }
        // --- ここまで移植したロジック ---

        async function startGame() {
            try {
                console.log('ゲームを開始しています...');
                const startBtn = document.getElementById('ready-btn');
                startBtn.disabled = true;
                startBtn.childNodes[0].textContent = '座標を生成中...';

                // 1. 共通の目標地点を生成
                const targetLocation = await generateTargetLocation();
                console.log('生成された目標地点:', targetLocation);

                // 2. 参加プレイヤーを取得
                const roomResponse = await fetch(`/multi/rooms/${roomId}`);
                const roomData = await roomResponse.json();
                if (!roomData.success) {
                    throw new Error('プレイヤー情報の取得に失敗しました。');
                }
                const players = roomData.data.players;

                // 3. プレイヤー開始位置はクライアント側で個別生成するため削除
                console.log('ターゲット位置が生成されました。各プレイヤーは個別にスポーン位置を決定します。');
                startBtn.childNodes[0].textContent = 'ゲームを開始中...';

                // ゲーム開始APIを呼び出す（ターゲット位置のみ送信）
                const response = await fetch(`/multi/rooms/${roomId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        targetLocation: targetLocation
                    })
                });

                // 詳細なレスポンス情報をログ出力
                console.log('ゲーム開始API レスポンス:', {
                    status: response.status,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ゲーム開始HTTP Error:', response.status, errorText);
                    showError(`ゲーム開始に失敗しました (${response.status}): ${errorText}`);
                startBtn.disabled = false;
                startBtn.childNodes[0].textContent = 'Game Start !!';
                    return;
                }

                const data = await response.json();
                console.log('ゲーム開始API データ:', data);

                if (data.success) {
                    console.log('ゲーム開始成功:', data);
                    stopPolling(); // ポーリングを停止
                    showGameStartMessage();
                    // ホストもゲーム画面に移動
                    setTimeout(() => {
                        window.location.href = `/online/views/online_game.html?roomId=${roomId}`;
                    }, 2000);
                } else {
                    console.error('ゲーム開始失敗:', data);
                    showError(data.message || 'ゲームの開始に失敗しました');
                startBtn.disabled = false;
                startBtn.childNodes[0].textContent = 'Game Start !!';
                }

            } catch (error) {
                console.error('ゲーム開始エラー:', error);
                showError(`ゲーム開始でネットワークエラーが発生しました: ${error.message}`);
                const startBtn = document.getElementById('ready-btn'); // エラー時もボタンを戻す
                startBtn.disabled = false;
            startBtn.childNodes[0].textContent = 'Game Start !!';
            }
        }

        async function leaveRoom() {
            if (!confirm('ルームを退出しますか？')) {
                return;
            }

            try {
                const response = await fetch(`/multi/rooms/${roomId}/leave`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = '/rooms';
                } else {
                    showError(data.message || 'ルーム退出に失敗しました');
                }

            } catch (error) {
                console.error('ルーム退出エラー:', error);
                showError('ネットワークエラーが発生しました');
            }
        }

        function startPolling() {
            pollInterval = setInterval(updateRoomInfo, 3000); // 3秒ごとに更新
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('error-display');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function showGameStartMessage() {
            // 既存のエラーメッセージを隠す
            const errorElement = document.getElementById('error-display');
            if (errorElement) {
                errorElement.style.display = 'none';
            }

            // ゲーム開始メッセージを表示
            const messageElement = document.createElement('div');
            messageElement.className = 'game-start-message';
            messageElement.innerHTML = `
                <div style="background-color: rgba(46, 204, 113, 0.1); border: 2px solid #2ecc71; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; color: #27ae60; text-align: center; font-size: 1.2rem; font-weight: bold;">
                    🎮 ゲームが開始されました！<br>
                    <span style="font-size: 1rem; font-weight: normal;">ゲーム画面に移動しています...</span>
                </div>
            `;

            const mainContent = document.querySelector('.main-content');
            const firstChild = mainContent.firstElementChild;
            mainContent.insertBefore(messageElement, firstChild);
        }

        // ページを離れる時にポーリングを停止
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });

        // コピー機能
        async function copyRoomKey() {
            const roomKey = document.getElementById('room-key-display').textContent;
            const copyBtn = document.getElementById('copy-btn');

            try {
                await navigator.clipboard.writeText(roomKey);

                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅';
                copyBtn.style.color = '#28a745';

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.color = '';
                }, 2000);

            } catch (error) {
                console.error('クリップボードコピーエラー:', error);
                alert('ルームキーをコピーできませんでした: ' + roomKey);
            }
        }
    </script>

    <div class="page-container">
        <header class="page-header">
            <h1 class="page-title">ルームロビー</h1>
            <p style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-top: 1rem; font-size: 1.1rem;">
                プレイヤーが集まるのを待っています
            </p>
        </header>

        <main class="main-content">
            <!-- エラー表示 -->
            <div id="error-display" class="error-message" style="display: none;"></div>

            <!-- ルーム情報とプレイヤーリストのコンテナ -->
            <div class="room-info-container">
                <!-- ルーム情報カード -->
                <div class="auth-box room-info-card">
                    <h2 class="auth-title">🏠 ルーム情報</h2>

                    <!-- ルームキー表示 -->
                    <div class="room-key-display">
                        <span class="label">ルームキー:</span>
                        <span id="room-key-display" class="room-key">------</span>
                        <button id="copy-btn" class="copy-btn" title="ルームキーをコピー" onclick="copyRoomKey()">📋</button>
                    </div>

                    <!-- ルーム設定情報 -->
                    <div class="room-details">
                        <p><strong>参加者:</strong> <span id="player-count">0</span>/<span id="max-players">4</span>人</p>
                        <p><strong>ラウンド数:</strong> <span id="round-count">3</span>ラウンド</p>
                    </div>
                </div>

                <!-- プレイヤーリスト -->
                <div class="auth-box players-card">
                    <h3 class="auth-title">👥 参加プレイヤー</h3>
                    <div id="players-list" class="players-list">
                        <!-- プレイヤーはJavaScriptで動的に追加されます -->
                    </div>
                </div>
            </div>

            <!-- アクションボタン -->
            <div style="max-width: 500px; margin: 0 auto;">
                <div class="action-buttons">
                    <button id="ready-btn" class="submit-btn" style="display: none;">準備OK</button>
                    <button id="leave-room-btn" class="secondary-btn">ルームを退出</button>
                </div>

                <!-- ヘルプテキスト -->
                <div style="margin-top: 1.5rem; padding: 1rem; background-color: rgba(52, 152, 219, 0.1); border-radius: 8px; border: 1px solid rgba(52, 152, 219, 0.3);">
                    <p style="margin: 0; font-size: 0.9rem; color: #2c3e50;">
                        <strong>💡 ゲーム開始条件:</strong><br>
                        • 最低2人のプレイヤーが必要です<br>
                        • 全ての参加者が「準備OK」状態になる必要があります<br>
                        • ホストが「ゲーム開始」ボタンを押すとゲームが始まります
                    </p>
                </div>
            </div>
        </main>
    </div>

    <style>
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .player-item {
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .player-status {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .player-status.ready {
            color: #27ae60;
        }

        .player-status.waiting {
            color: #f39c12;
        }

        .ready-active {
            background: linear-gradient(135deg, #27ae60, #229954) !important;
        }

        .error-message {
            background-color: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #e74c3c;
            text-align: center;
        }

        /* ホスト用ゲームスタートボタンのスタイル（rules.htmlから応用） */
        .lobby-start-game-button {
            position: relative;
            padding: 20px 50px;
            margin: 20px auto;
            display: block;
            background: #fec195;
            font-size: 24px;
            font-weight: 600;
            color: #181818;
            border: 4px solid #fec195;
            border-radius: 12px;
            box-shadow: 0 0 0 #fec1958c;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            text-align: center;
            max-width: 400px;
            width: 100%;
            min-height: 80px;
        }

        .lobby-start-game-button:disabled {
            background: #cccccc;
            border-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }

        .lobby-start-game-button:disabled .star-1,
        .lobby-start-game-button:disabled .star-2,
        .lobby-start-game-button:disabled .star-3,
        .lobby-start-game-button:disabled .star-4,
        .lobby-start-game-button:disabled .star-5,
        .lobby-start-game-button:disabled .star-6 {
            display: none;
        }

        .lobby-start-game-button .star-1,
        .lobby-start-game-button .star-2,
        .lobby-start-game-button .star-3,
        .lobby-start-game-button .star-4,
        .lobby-start-game-button .star-5,
        .lobby-start-game-button .star-6 {
            position: absolute;
            filter: drop-shadow(0 0 0 #fffdef);
            z-index: -5;
            transition: all 1s cubic-bezier(0.05, 0.83, 0.43, 0.96);
        }

        .lobby-start-game-button .star-1 {
            top: 20%;
            left: 20%;
            width: 25px;
            height: auto;
        }

        .lobby-start-game-button .star-2 {
            top: 45%;
            left: 45%;
            width: 15px;
            height: auto;
        }

        .lobby-start-game-button .star-3 {
            top: 40%;
            left: 40%;
            width: 5px;
            height: auto;
        }

        .lobby-start-game-button .star-4 {
            top: 20%;
            left: 40%;
            width: 8px;
            height: auto;
        }

        .lobby-start-game-button .star-5 {
            top: 25%;
            left: 45%;
            width: 15px;
            height: auto;
        }

        .lobby-start-game-button .star-6 {
            top: 5%;
            left: 50%;
            width: 5px;
            height: auto;
        }

        .lobby-start-game-button:not(:disabled):hover {
            background: transparent;
            color: #fec195;
            box-shadow: 0 0 25px #fec1958c;
        }

        .lobby-start-game-button:not(:disabled):hover .star-1 {
            top: -80%;
            left: -30%;
            filter: drop-shadow(0 0 10px #fffdef);
            z-index: 2;
        }

        .lobby-start-game-button:not(:disabled):hover .star-2 {
            top: -25%;
            left: 10%;
            filter: drop-shadow(0 0 10px #fffdef);
            z-index: 2;
        }

        .lobby-start-game-button:not(:disabled):hover .star-3 {
            top: 55%;
            left: 25%;
            filter: drop-shadow(0 0 10px #fffdef);
            z-index: 2;
        }

        .lobby-start-game-button:not(:disabled):hover .star-4 {
            top: 30%;
            left: 80%;
            filter: drop-shadow(0 0 10px #fffdef);
            z-index: 2;
        }

        .lobby-start-game-button:not(:disabled):hover .star-5 {
            top: 25%;
            left: 115%;
            filter: drop-shadow(0 0 10px #fffdef);
            z-index: 2;
        }

        .lobby-start-game-button:not(:disabled):hover .star-6 {
            top: 5%;
            left: 60%;
            filter: drop-shadow(0 0 10px #fffdef);
            z-index: 2;
        }

        .lobby-start-game-button .fil0 {
            fill: #fffdef;
        }

        /* ルーム情報とプレイヤーリストの横並び */
        .room-info-container {
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto 2rem auto;
            align-items: flex-start;
        }

        .room-info-card,
        .players-card {
            flex: 1;
            max-width: none;
            min-width: 300px;
        }

        .room-info-card {
            flex-basis: 45%;
        }

        .players-card {
            flex-basis: 55%;
        }

        @media (max-width: 768px) {
            .room-info-container {
                flex-direction: column;
                gap: 1.5rem;
            }

            .room-info-card,
            .players-card {
                flex-basis: auto;
                max-width: 500px;
                margin: 0 auto;
            }
        }

        @media (max-width: 480px) {
            .player-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .room-info-container {
                gap: 1rem;
            }
        }
    </style>
</body>
</html>