// üéÆ online_game.js Ê©üËÉΩ„ÉÜ„Çπ„Éà

// JSDOM„Çí‰Ωø„Å£„Å¶„Éñ„É©„Ç¶„Ç∂Áí∞Â¢É„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
const { JSDOM } = require('jsdom');
// fetch API„Çí„É¢„ÉÉ„ÇØ
const fetchMock = require('jest-fetch-mock');

fetchMock.enableMocks();

describe('„Ç™„É≥„É©„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢ (online_game.js) „ÅÆÊ©üËÉΩ„ÉÜ„Çπ„Éà', () => {
    let dom;
    let window;
    let document;

    // ÂêÑ„ÉÜ„Çπ„Éà„ÅÆÂâç„Å´DOM„Å®„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
    beforeEach(async () => {
        // online_game.html„ÅÆÂü∫Êú¨ÊßãÈÄ†„ÇíË™≠„ÅøËæº„ÇÄ
        dom = await JSDOM.fromFile('./public/online/views/online_game.html', {
            runScripts: 'dangerously',
            resources: 'usable',
            url: 'http://localhost/online/views/online_game.html?roomId=test-room-id'
        });

        window = dom.window;
        document = window.document;

        // fetch„Çí„É™„Çª„ÉÉ„Éà
        fetchMock.resetMocks();

        // „Ç∞„É≠„Éº„Éê„É´API„ÅÆ„É¢„ÉÉ„ÇØ
        window.google = {
            maps: {
                Map: jest.fn(() => ({
                    setStreetView: jest.fn(),
                    setCenter: jest.fn(),
                    setZoom: jest.fn(),
                    addListener: jest.fn(),
                })),
                StreetViewPanorama: jest.fn(() => ({
                    addListener: jest.fn(),
                })),
                Marker: jest.fn(function(options) { // `function` „Ç≠„Éº„ÉØ„Éº„Éâ„Åß `this` „ÇíÊùüÁ∏õ
                    this.position = options.position;
                    this.map = options.map;
                    this.setMap = jest.fn();
                    this.setPosition = jest.fn((newPos) => {
                        this.position = newPos;
                    });
                    this.getPosition = jest.fn(() => this.position);
                    return this;
                }),
                LatLng: jest.fn((lat, lng) => ({ lat: () => lat, lng: () => lng })),
                SymbolPath: {
                    CIRCLE: 'circle_path'
                },
                event: {
                    addListener: jest.fn(),
                },
            },
        };

        // Â§ñÈÉ®„É©„Ç§„Éñ„É©„É™„ÅÆ„É¢„ÉÉ„ÇØ
        window.confetti = jest.fn();

        // online_game.jsÂÜÖ„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíË®≠ÂÆö
        window.roomId = 'test-room-id';
        window.currentUser = { id: 'user-self', username: 'Ëá™ÂàÜ' };
    });

    // „ÉÜ„Çπ„Éà„Éò„É´„Éë„ÉºÔºöÈùûÂêåÊúüÂá¶ÁêÜ„ÇíÂæÖÊ©ü
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    describe('‰ªñ„Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±Ë°®Á§∫Ê©üËÉΩ', () => {

        test('Êñ∞„Åó„ÅÑ„Éó„É¨„Ç§„É§„Éº„ÅåÂèÇÂä†„Åó„ÅüÊôÇ„ÄÅ„Éû„Éº„Ç´„Éº„ÅåÊ≠£„Åó„Åè‰ΩúÊàê„Åï„Çå„Çã', () => {
            const playersData = [
                { userId: 'user-self', username: 'Ëá™ÂàÜ' },
                {
                    userId: 'user-2',
                    username: '„Éó„É¨„Ç§„É§„Éº2',
                    currentPosition: { lat: 35.6, lng: 139.7 }
                }
            ];

            // „ÉÜ„Çπ„ÉàÂØæË±°„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
            window.updateOtherPlayerMarkers(playersData);

            // „Éû„Éº„Ç´„Éº„Åå1„Å§„Å†„Åë‰ΩúÊàê„Åï„Çå„Åü„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(window.google.maps.Marker).toHaveBeenCalledTimes(1);
            // ‰ΩúÊàê„Åï„Çå„Åü„Éû„Éº„Ç´„Éº„Åå„Éó„É¨„Ç§„É§„Éº2„ÅÆ„ÇÇ„ÅÆ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(window.otherPlayerMarkers['user-2']).toBeDefined();
            expect(window.otherPlayerMarkers['user-2'].getPosition().lat()).toBe(35.6);
            // Ëá™ÂàÜËá™Ë∫´„ÅÆ„Éû„Éº„Ç´„Éº„ÅØ‰ΩúÊàê„Åï„Çå„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(window.otherPlayerMarkers['user-self']).toBeUndefined();
        });

        test('„Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆ„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÊôÇ„ÄÅÊó¢Â≠ò„Éû„Éº„Ç´„Éº„ÅÆ‰ΩçÁΩÆ„ÅåÊõ¥Êñ∞„Åï„Çå„Çã', () => {
            // ÂàùÊúüÁä∂ÊÖãÔºö„Éó„É¨„Ç§„É§„Éº2„ÅÆ„Éû„Éº„Ç´„Éº„Çí‰ΩúÊàê
            const initialPlayers = [{
                userId: 'user-2',
                username: '„Éó„É¨„Ç§„É§„Éº2',
                currentPosition: { lat: 35.6, lng: 139.7 }
            }];
            window.updateOtherPlayerMarkers(initialPlayers);

            const markerInstance = window.otherPlayerMarkers['user-2'];
            expect(markerInstance.getPosition().lat()).toBe(35.6);

            // Êõ¥Êñ∞Áä∂ÊÖãÔºö„Éó„É¨„Ç§„É§„Éº2„ÅÆ‰ΩçÁΩÆ„ÅåÂ§â„Çè„Çã
            const updatedPlayers = [{
                userId: 'user-2',
                username: '„Éó„É¨„Ç§„É§„Éº2',
                currentPosition: { lat: 35.61, lng: 139.71 }
            }];
            window.updateOtherPlayerMarkers(updatedPlayers);

            // setPosition„ÅåÊñ∞„Åó„ÅÑÂ∫ßÊ®ô„ÅßÂëº„Å≥Âá∫„Åï„Çå„Åü„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(markerInstance.setPosition).toHaveBeenCalledWith(expect.objectContaining({
                lat: expect.any(Function), // LatLng„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ„É¢„ÉÉ„ÇØ
                lng: expect.any(Function),
            }));
            // ÂÜÖÈÉ®ÁöÑ„Å´‰ΩçÁΩÆ„ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(markerInstance.getPosition().lat()).toBe(35.61);
        });

        test('„Éó„É¨„Ç§„É§„Éº„ÅåÈÄÄÂá∫„Åó„ÅüÊôÇ„ÄÅ„Éû„Éº„Ç´„Éº„Åå„Éû„ÉÉ„Éó„Åã„ÇâÂâäÈô§„Åï„Çå„Çã', () => {
            // ÂàùÊúüÁä∂ÊÖãÔºö2‰∫∫„ÅÆ‰ªñ„Éó„É¨„Ç§„É§„Éº„Éû„Éº„Ç´„Éº„Çí‰ΩúÊàê
            const initialPlayers = [
                { userId: 'user-2', username: '„Éó„É¨„Ç§„É§„Éº2', currentPosition: { lat: 35.6, lng: 139.7 } },
                { userId: 'user-3', username: '„Éó„É¨„Ç§„É§„Éº3', currentPosition: { lat: 35.7, lng: 139.8 } }
            ];
            window.updateOtherPlayerMarkers(initialPlayers);

            expect(Object.keys(window.otherPlayerMarkers)).toHaveLength(2);
            const marker2 = window.otherPlayerMarkers['user-2'];

            // Êõ¥Êñ∞Áä∂ÊÖãÔºö„Éó„É¨„Ç§„É§„Éº2„ÅåÈÄÄÂá∫
            const updatedPlayers = [
                { userId: 'user-3', username: '„Éó„É¨„Ç§„É§„Éº3', currentPosition: { lat: 35.7, lng: 139.8 } }
            ];
            window.updateOtherPlayerMarkers(updatedPlayers);

            // „Éó„É¨„Ç§„É§„Éº2„ÅÆ„Éû„Éº„Ç´„Éº„ÅåÂâäÈô§„Åï„Çå„Åü„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(marker2.setMap).toHaveBeenCalledWith(null);
            expect(window.otherPlayerMarkers['user-2']).toBeUndefined();
            // „Éó„É¨„Ç§„É§„Éº3„ÅÆ„Éû„Éº„Ç´„Éº„ÅØÊÆã„Å£„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(window.otherPlayerMarkers['user-3']).toBeDefined();
            expect(Object.keys(window.otherPlayerMarkers)).toHaveLength(1);
        });
    });

    describe('Ëá™ÂàÜ„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±ÈÄÅ‰ø°Ê©üËÉΩ', () => {

        beforeEach(() => {
            // panorama„ÅÆ„É¢„ÉÉ„ÇØ„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
            window.panorama = {
                listeners: {},
                addListener: function(event, callback) {
                    this.listeners[event] = callback;
                },
                getPosition: jest.fn(() => new window.google.maps.LatLng(35.5, 139.5)),
                // „ÉÜ„Çπ„ÉàÁî®„ÅÆ„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´Èñ¢Êï∞
                trigger: function(event) {
                    if (this.listeners[event]) {
                        this.listeners[event]();
                    }
                }
            };
            window.setupPositionUpdateEvents();
        });

        test('position_changed„Ç§„Éô„É≥„Éà„ÅßsendPositionUpdate„ÅåÂëº„Å≥Âá∫„Åï„Çå„Çã', async () => {
            fetchMock.mockResponseOnce(JSON.stringify({ success: true }));

            // „Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
            window.panorama.trigger('position_changed');

            // fetch„ÅåÊ≠£„Åó„ÅÑ„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Å®„Éá„Éº„Çø„ÅßÂëº„Å∞„Çå„Åü„ÅãÁ¢∫Ë™ç
            expect(fetchMock).toHaveBeenCalledWith(
                '/multi/rooms/test-room-id/position',
                expect.objectContaining({
                    method: 'PUT',
                    body: JSON.stringify({ lat: 35.5, lng: 139.5 })
                })
            );
        });

        test('1ÁßíÈñì„ÅÆ„Çπ„É≠„ÉÉ„Éà„É™„É≥„Ç∞„ÅåÊ©üËÉΩ„Åô„Çã', async () => {
            jest.useFakeTimers();
            fetchMock.mockResponse(JSON.stringify({ success: true }));

            // Áü≠ÊôÇÈñì„Å´3Âõû„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
            window.panorama.trigger('position_changed');
            await wait(100);
            window.panorama.trigger('position_changed');
            await wait(100);
            window.panorama.trigger('position_changed');

            // fetch„ÅØ1Âõû„Åó„ÅãÂëº„Å∞„Çå„Å™„ÅÑ
            expect(fetchMock).toHaveBeenCalledTimes(1);

            // 1ÁßíÂæÖÊ©ü
            jest.advanceTimersByTime(1000);

            // ÂÜçÂ∫¶„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
            window.panorama.trigger('position_changed');

            // fetch„ÅåÂêàË®à2ÂõûÂëº„Å∞„Çå„Çã
            expect(fetchMock).toHaveBeenCalledTimes(2);

            jest.useRealTimers();
        });
    });

    describe('„Çπ„Éù„Éº„É≥Ê©üËÉΩ„Å®LatLng„Ç®„É©„Éº‰øÆÊ≠£„ÉÜ„Çπ„Éà', () => {

        beforeEach(() => {
            // Google Maps geometryÊ©üËÉΩ„ÅÆ„É¢„ÉÉ„ÇØ
            window.google.maps.geometry = {
                spherical: {
                    computeDistanceBetween: jest.fn(() => 1500), // 1.5km
                    computeOffset: jest.fn((point, distance, heading) =>
                        new window.google.maps.LatLng(35.6 + 0.01, 139.7 + 0.01)
                    )
                }
            };

            // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆ„É¢„ÉÉ„ÇØ
            window.gameState = {
                targetLocation: { lat: 35.681236, lng: 139.767125 }, // „Éó„É¨„Éº„É≥„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                playerStartLocation: { lat: 35.68, lng: 139.76 }
            };

            window.players = [
                {
                    userId: 'user-self',
                    username: 'Ëá™ÂàÜ',
                    currentPosition: { lat: 35.685, lng: 139.770 }
                },
                {
                    userId: 'user-2',
                    username: '„Éó„É¨„Ç§„É§„Éº2',
                    currentPosition: { lat: 35.675, lng: 139.765 }
                }
            ];

            window.targetLocation = null;
            window.initialPlayerLocation = null;
            window.initialPlayerDistance = 0;
        });

        test('targetLocation„Åå„Éó„É¨„Éº„É≥„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâLatLng„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Ê≠£„Åó„ÅèÂ§âÊèõ„Åï„Çå„Çã', () => {
            // initializeMapÁõ∏ÂΩì„ÅÆÂá¶ÁêÜ„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
            const mockMap = new window.google.maps.Map();
            const mockPanorama = new window.google.maps.StreetViewPanorama();

            // targetLocation„ÇíË®≠ÂÆöÔºà‰øÆÊ≠£Âæå„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÔºâ
            window.targetLocation = new window.google.maps.LatLng(
                window.gameState.targetLocation.lat,
                window.gameState.targetLocation.lng
            );

            expect(window.targetLocation.lat).toBeDefined();
            expect(window.targetLocation.lng).toBeDefined();
            expect(window.targetLocation.lat()).toBe(35.681236);
            expect(window.targetLocation.lng()).toBe(139.767125);
        });

        test('startOnlineGameSession„ÅßLatLng„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅåÊ≠£„Åó„ÅèÂá¶ÁêÜ„Åï„Çå„Çã', () => {
            // Èñ¢Êï∞„Çí„É¢„ÉÉ„ÇØÂÆüË£Ö
            window.startOnlineGameSession = function(targetPos, playerPos) {
                // Âûã„ÇíÁµ±‰∏ÄÔºà‰øÆÊ≠£Âæå„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÔºâ
                const targetLatLng = targetPos instanceof window.google.maps.LatLng ?
                    targetPos : new window.google.maps.LatLng(targetPos.lat, targetPos.lng);
                const playerLatLng = playerPos instanceof window.google.maps.LatLng ?
                    playerPos : new window.google.maps.LatLng(playerPos.lat, playerPos.lng);

                window.initialPlayerLocation = {
                    lat: playerLatLng.lat(),
                    lng: playerLatLng.lng()
                };

                window.initialPlayerDistance = window.google.maps.geometry.spherical.computeDistanceBetween(
                    playerLatLng,
                    targetLatLng
                );

                return { targetLatLng, playerLatLng };
            };

            // „Éó„É¨„Éº„É≥„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅßÂëº„Å≥Âá∫„Åó
            const targetPos = { lat: 35.681236, lng: 139.767125 };
            const playerPos = { lat: 35.685, lng: 139.770 };

            const result = window.startOnlineGameSession(targetPos, playerPos);

            expect(result.targetLatLng.lat()).toBe(35.681236);
            expect(result.playerLatLng.lat()).toBe(35.685);
            expect(window.initialPlayerLocation.lat).toBe(35.685);
            expect(window.initialPlayerDistance).toBe(1500);

            // LatLng„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅßÂëº„Å≥Âá∫„Åó
            const targetLatLng = new window.google.maps.LatLng(35.681236, 139.767125);
            const playerLatLng = new window.google.maps.LatLng(35.685, 139.770);

            const result2 = window.startOnlineGameSession(targetLatLng, playerLatLng);

            expect(result2.targetLatLng.lat()).toBe(35.681236);
            expect(result2.playerLatLng.lat()).toBe(35.685);
        });

        test('„Éó„É¨„Ç§„É§„ÉºÂÄãÂà•„Çπ„Éù„Éº„É≥‰ΩçÁΩÆ„ÅåÊ≠£„Åó„ÅèÂèñÂæó„Åï„Çå„Çã', () => {
            window.setPlayerStartPosition = function() {
                const currentPlayer = window.players.find(p => p.userId === window.currentUser.id);

                if (currentPlayer && currentPlayer.currentPosition) {
                    const playerStartPos = new window.google.maps.LatLng(
                        currentPlayer.currentPosition.lat,
                        currentPlayer.currentPosition.lng
                    );

                    window.panorama = { setPosition: jest.fn() };
                    window.panorama.setPosition(playerStartPos);

                    window.initialPlayerLocation = {
                        lat: playerStartPos.lat(),
                        lng: playerStartPos.lng()
                    };

                    return playerStartPos;
                }

                return null;
            };

            const result = window.setPlayerStartPosition();

            expect(result).toBeDefined();
            expect(result.lat()).toBe(35.685);
            expect(result.lng()).toBe(139.770);
            expect(window.panorama.setPosition).toHaveBeenCalledWith(result);
            expect(window.initialPlayerLocation.lat).toBe(35.685);
        });

        test('Áï∞„Å™„Çã„Éó„É¨„Ç§„É§„Éº„ÅåÁï∞„Å™„Çã„Çπ„Éù„Éº„É≥‰ΩçÁΩÆ„ÇíÂèñÂæó„Åô„Çã', () => {
            window.generatePlayerStartPosition = function(targetLocation, playerIndex, totalPlayers) {
                const angleSegment = (2 * Math.PI) / Math.max(totalPlayers, 2);
                const baseAngle = angleSegment * playerIndex;
                const angleVariation = angleSegment * 0.8;
                const angle = baseAngle + (Math.random() * angleVariation - angleVariation / 2);
                const distance = 500 + Math.random() * 2500;

                const lat = targetLocation.lat + (distance * Math.cos(angle)) / 111320;
                const lng = targetLocation.lng + (distance * Math.sin(angle)) / (111320 * Math.cos(targetLocation.lat * Math.PI / 180));

                return { lat, lng };
            };

            const targetLocation = { lat: 35.681236, lng: 139.767125 };

            // 2‰∫∫„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÁîüÊàê
            const pos1 = window.generatePlayerStartPosition(targetLocation, 0, 2);
            const pos2 = window.generatePlayerStartPosition(targetLocation, 1, 2);

            // Áï∞„Å™„Çã‰ΩçÁΩÆ„ÅåÁîüÊàê„Åï„Çå„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(pos1.lat).not.toBe(pos2.lat);
            expect(pos1.lng).not.toBe(pos2.lng);

            // „Çø„Éº„Ç≤„ÉÉ„Éà‰ΩçÁΩÆ„Åã„ÇâÂçÅÂàÜÈõ¢„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            expect(Math.abs(pos1.lat - targetLocation.lat)).toBeGreaterThan(0.001);
            expect(Math.abs(pos2.lat - targetLocation.lat)).toBeGreaterThan(0.001);
        });
    });
});